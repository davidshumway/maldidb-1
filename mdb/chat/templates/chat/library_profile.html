{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}

{% block title %}
	Library Details: {{ library.title }}
{% endblock %}

{% block content %}

<link rel="stylesheet" type="text/css"
  href="{% static 'css/datatables.min.css' %}"/>
 
<script type="text/javascript" src="{% static 'js/datatables.min.js' %}">
  </script>

<div class="row">

<div class="col-sm-3">
<div class="card">
  <div class="card-header">Library details</div>
	<div class="card-body">
		<div class="card-title">
			Title: {{ library.title }}
		</div>
		<div class="card-title">
			Description: {{ library.description }}
		</div>
		<div class="card-title">
			Privacy Setting: {{ library.privacy_level }}
		</div>
		<div class="card-title">
			Quality: {{ library.quality_rating }}
		</div>
		<div class="card-title">
			Created by: {{ library.created_by }}
		</div>
		<div class="card-title">
			Lab: {{ library.lab }}
		</div>
		<div class="card-title"><!--TODO: href-->
			Spectra:
			<a href="{% url 'spectra_search:spectra_results' %}?library={{library.id}}" class="card-link">
				{{ spectra|length }}</a>
		</div>
		<div class="card-title"><!--TODO: href-->
			Collapsed spectra:
			<a href="{% url 'spectra_search:spectra_results2' %}?library={{library.id}}" class="card-link">
				{{ collapsed_spectra|length }}</a>
		</div>
		<div class="card-title"><!--TODO: href-->
			Metadata:
			<a href="{% url 'chat:metadata_results' %}?library={{library.id}}" class="card-link">
				{{ metadata|length }}</a>
		</div>
<!--
	only lab owners can add/update/remove libraries
-->
	{% if request.user in lab.owners.all %}
		<div class="card-body">
			<a href="{% url 'chat:edit_libprofile' library.id %}" class="card-link btn btn-danger">
				Edit Library Details</a>
		</div>
	{% endif %}
  </div>
</div>
</div>

{% if request.user in lab.owners.all %}
<div class="col-sm-9">
<div class="card">
  <div class="card-header">Library options</div>
	<div class="card-body">
    <button onclick="javascript:align();">Align metadata with NCBI</button>
    <table id="align" class="table-bordered table-responsive table-condensed"></table> <!-- cell-border compact stripe-->
  </div>
</div>
</div>

<script type="text/javascript">
var socket = new WebSocket('ws://' + location.host + '/ws/pollData');
socket.onopen = function(e){
  //console.log(e);
}
socket.onmessage = function(e) {
  console.log(e);
  var data = JSON.parse(e.data).data;
  console.log(data);
  
  // exact matches versus non-matches
  if (data.data) {
    var t = $('#align').DataTable({
      data: data.data.result,
      columns: [
        {data: 'id', title: 'ID'},
        {data: 'strain_id', title: 'Strain ID'},
        //~ {data: 'strain_id__strain_id', title: 'Strain Name'},
        {data: 'exact', title: 'Exact match',
          render: function(data, type) {
            return data.split('|').join('<br>');
          }
        },
        {data: 'partial_type', title: 'Partial search'},//,
        {data: 'partial', title: 'Partial result',
          render: function(data, type) {
            return data.split('|').join('<br>');
          }
        }
      ]
    });
    t.draw();
  }
}
socket.onclose = function(e){
  //console.log(e);
}
function align() {
  socket.send(JSON.stringify({
    align: {
      library: {{ library.id }}
    }
  }));
}
</script>
{% endif %}

<!--End row-->
</div>

{% endblock %}
